name: K6 Performance Tests CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # Job 1: Initialize and Setup
  setup:
    name: ğŸ”§ Initialize & Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build tests
        run: npm run build
      
      - name: ğŸš€ Install k6
        uses: grafana/setup-k6-action@v1
      
      - name: ğŸ” Verify k6 installation
        run: k6 version

  # Job 2: Validation
  validate:
    name: âœ… Validation
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      - name: ğŸ” Check TypeScript compilation
        run: npm run build
      
      - name: ğŸ“‹ Validate test files
        run: |
          test -f tests/api-test.ts && echo "âœ“ api-test.ts"
          test -f tests/load-test.ts && echo "âœ“ load-test.ts"
          test -f tests/stress-test.ts && echo "âœ“ stress-test.ts"
          test -f tests/spike-test.ts && echo "âœ“ spike-test.ts"
          test -f tests/volume-test.ts && echo "âœ“ volume-test.ts"
          test -f tests/soak-test.ts && echo "âœ“ soak-test.ts"

  # Job 3: Run Tests
  test:
    name: ğŸ§ª Run K6 Tests
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        test: [api, load, stress, spike, volume, soak]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build tests
        run: npm run build
      
      - name: ğŸš€ Install k6
        uses: grafana/setup-k6-action@v1
      
      - name: ğŸ” Verify Grafana Cloud Configuration
        env:
          K6_CLOUD_HOST: ${{ secrets.GRAFANA_CLOUD_HOST }}
          K6_CLOUD_PROJECT_ID: ${{ secrets.GRAFANA_CLOUD_PROJECT_ID }}
          K6_CLOUD_TOKEN: ${{ secrets.GRAFANA_CLOUD_API_TOKEN }}
        run: |
          echo "ğŸ”§ Grafana Cloud Configuration:"
          echo "  Host: ${K6_CLOUD_HOST:-NOT SET}"
          echo "  Project ID: ${K6_CLOUD_PROJECT_ID:-NOT SET}"
          if [ -n "$K6_CLOUD_TOKEN" ]; then
            echo "  Token: SET"
          else
            echo "  Token: NOT SET"
          fi
      
      - name: ğŸ§ª Run ${{ matrix.test }} test and send to Grafana Cloud
        env:
          K6_CLOUD_TOKEN: ${{ secrets.GRAFANA_CLOUD_API_TOKEN }}
          K6_CLOUD_HOST: ${{ secrets.GRAFANA_CLOUD_HOST }}
          K6_CLOUD_PROJECT_ID: ${{ secrets.GRAFANA_CLOUD_PROJECT_ID }}
        run: k6 cloud dist/${{ matrix.test }}-test.js

  # Job 4: Summary
  summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“ Display summary
        run: |
          echo "âœ… All k6 tests completed"
          echo "ğŸ“Š View results in Grafana Cloud"
          echo "ğŸ”— Dashboard: https://grafana.com/cloud"
